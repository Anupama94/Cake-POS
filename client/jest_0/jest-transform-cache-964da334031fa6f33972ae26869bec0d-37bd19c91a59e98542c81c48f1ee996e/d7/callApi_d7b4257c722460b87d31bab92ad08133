76608cb1c28cb6f170cd3acf3d0d4c02
"use strict";

var _interopRequireDefault = require("/home/anupamaa/Desktop/Training/pos/server/client/node_modules/@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getMenuItems = exports.getUsersOrders = exports.updateOrder = exports.getOrderItems = exports.userLogin = void 0;

var _config = require("../apiCalls/config");

var _axios = _interopRequireDefault(require("axios"));

var _errorConstants = require("./errorConstants");

var _httpStatusCodes = _interopRequireDefault(require("http-status-codes"));

const baseUrl = "http://localhost:3001/";

const userLogin = credentials => {
  return new Promise((resolve, reject) => {
    postCall("users/login", credentials).then(result => {
      if (result.status === _httpStatusCodes.default.OK) {
        _config.apiConfig.authenticationToken = result.data.token;
        _config.apiConfig.userId = result.data.id;
        resolve();
      }
    }).catch(err => {
      if (err.response.status === _httpStatusCodes.default.UNAUTHORIZED) {
        reject({
          message: _errorConstants.error.AUTH_FAILED.MESSAGE,
          code: _errorConstants.error.AUTH_FAILED.CODE
        });
      } else if (err.response.status === _httpStatusCodes.default.INTERNAL_SERVER_ERROR) {
        reject({
          message: _errorConstants.error.SERVICE_UNAVAILABLE.MESSAGE,
          code: _errorConstants.error.SERVICE_UNAVAILABLE.CODE
        });
      } else {
        reject({
          message: _errorConstants.error.UNRECOGNIZED_ERROR.MESSAGE,
          code: _errorConstants.error.UNRECOGNIZED_ERROR.CODE
        });
      }
    });
  });
};

exports.userLogin = userLogin;

const getOrderItems = orderId => {
  return new Promise((resolve, reject) => {
    authenticatedGetCall("orders/" + orderId).then(result => {
      if (result.status === _httpStatusCodes.default.OK) {
        resolve(result);
      } else if (result.status === _httpStatusCodes.default.NOT_FOUND) {
        resolve(result);
      }
    }).catch(err => {
      if (err.response.status === _httpStatusCodes.default.INTERNAL_SERVER_ERROR) {
        reject({
          message: _errorConstants.error.SERVICE_UNAVAILABLE.MESSAGE,
          code: _errorConstants.error.SERVICE_UNAVAILABLE.CODE
        });
      } else {
        reject({
          message: _errorConstants.error.UNRECOGNIZED_ERROR.MESSAGE,
          code: _errorConstants.error.UNRECOGNIZED_ERROR.CODE
        });
      }
    });
  });
};

exports.getOrderItems = getOrderItems;

const updateOrder = (orderId, updateOps) => {
  return new Promise((resolve, reject) => {
    putCall("orders/" + orderId, updateOps).then(result => {
      resolve(result);
    }).catch(err => {
      reject();
    });
  });
}; // this needs to be changed


exports.updateOrder = updateOrder;

const getUsersOrders = () => {
  return new Promise((resolve, reject) => {
    console.log(_config.apiConfig.userId);
    authenticatedGetCall("orders/all/" + _config.apiConfig.userId).then(result => {
      resolve(result);
    }).catch(err => {
      reject();
    });
  });
};

exports.getUsersOrders = getUsersOrders;

const getMenuItems = () => {
  return new Promise((resolve, reject) => {
    authenticatedGetCall("items/").then(result => {
      resolve(result);
    }).catch(err => {
      reject();
    });
  });
};
/*
    POST, GET, PUT calls defined
 */


exports.getMenuItems = getMenuItems;

function postCall(url, mydata) {
  return new Promise((resolve, reject) => {
    let callingUrl = baseUrl + url;

    _axios.default.post(callingUrl, mydata).then(response => {
      if (response.status === _httpStatusCodes.default.OK || response.status === _httpStatusCodes.default.CREATED) {
        resolve(response);
      }
    }).catch(err => {
      if (err.response.status === _httpStatusCodes.default.UNAUTHORIZED) {
        console.log("Unauthorized request initiated from axios post call in callApi.js");
        reject(err);
      } else if (err.response.status === _httpStatusCodes.default.INTERNAL_SERVER_ERROR) {
        console.log("Internal Server Error initiated from axios post call in callApi.js");
        reject(err);
      } else {
        console.log(_errorConstants.error.UNEXPECTED_ERROR.MESSAGE + " initiated from  axios post call in callApi.js");
        reject(err);
      }
    });
  });
}

function authenticatedGetCall(url, header) {
  const requestHeader = {
    headers: {
      "Authorization": "Bearer " + _config.apiConfig.authenticationToken
    }
  };
  return new Promise((resolve, reject) => {
    let callingUrl = baseUrl + url; // resolve(axios.get(callingUrl, requestHeader)
    //     .then(response => {
    //         return response;
    //     }));

    _axios.default.get(callingUrl, requestHeader).then(response => {
      if (response.status === _httpStatusCodes.default.OK || err.response.status === _httpStatusCodes.default.NOT_FOUND) {
        resolve(response);
      }
    }).catch(err => {
      if (err.response.status === _httpStatusCodes.default.INTERNAL_SERVER_ERROR) {
        console.log("Internal Server Error initiated from axios authenticatedGetCall in callApi.js");
        reject(err);
      } else {
        console.log(_errorConstants.error.UNEXPECTED_ERROR.MESSAGE + " initiated from  axios authenticatedGetCall in callApi.js");
        reject(err);
      }
    });
  });
}

function putCall(url, updateOps) {
  return new Promise((resolve, reject) => {
    let callingUrl = baseUrl + url;
    resolve(_axios.default.put(callingUrl, updateOps).then(response => {
      return response;
    }));
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhbGxBcGkuanMiXSwibmFtZXMiOlsiYmFzZVVybCIsInVzZXJMb2dpbiIsImNyZWRlbnRpYWxzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJwb3N0Q2FsbCIsInRoZW4iLCJyZXN1bHQiLCJzdGF0dXMiLCJIdHRwU3RhdHVzIiwiT0siLCJhcGlDb25maWciLCJhdXRoZW50aWNhdGlvblRva2VuIiwiZGF0YSIsInRva2VuIiwidXNlcklkIiwiaWQiLCJjYXRjaCIsImVyciIsInJlc3BvbnNlIiwiVU5BVVRIT1JJWkVEIiwibWVzc2FnZSIsImVycm9yIiwiQVVUSF9GQUlMRUQiLCJNRVNTQUdFIiwiY29kZSIsIkNPREUiLCJJTlRFUk5BTF9TRVJWRVJfRVJST1IiLCJTRVJWSUNFX1VOQVZBSUxBQkxFIiwiVU5SRUNPR05JWkVEX0VSUk9SIiwiZ2V0T3JkZXJJdGVtcyIsIm9yZGVySWQiLCJhdXRoZW50aWNhdGVkR2V0Q2FsbCIsIk5PVF9GT1VORCIsInVwZGF0ZU9yZGVyIiwidXBkYXRlT3BzIiwicHV0Q2FsbCIsImdldFVzZXJzT3JkZXJzIiwiY29uc29sZSIsImxvZyIsImdldE1lbnVJdGVtcyIsInVybCIsIm15ZGF0YSIsImNhbGxpbmdVcmwiLCJheGlvcyIsInBvc3QiLCJDUkVBVEVEIiwiVU5FWFBFQ1RFRF9FUlJPUiIsImhlYWRlciIsInJlcXVlc3RIZWFkZXIiLCJoZWFkZXJzIiwiZ2V0IiwicHV0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxPQUFPLEdBQUcsd0JBQWhCOztBQUVPLE1BQU1DLFNBQVMsR0FBSUMsV0FBRCxJQUFpQjtBQUN0QyxTQUFPLElBQUlDLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDcENDLElBQUFBLFFBQVEsQ0FBQyxhQUFELEVBQWdCSixXQUFoQixDQUFSLENBQ0tLLElBREwsQ0FDVUMsTUFBTSxJQUFJO0FBQ1osVUFB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c291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYXBpQ29uZmlnIH0gZnJvbSAnLi4vYXBpQ2FsbHMvY29uZmlnJztcbmltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQgeyBlcnJvciB9IGZyb20gJy4vZXJyb3JDb25zdGFudHMnO1xuaW1wb3J0IEh0dHBTdGF0dXMgZnJvbSAnaHR0cC1zdGF0dXMtY29kZXMnO1xuXG5jb25zdCBiYXNlVXJsID0gXCJodHRwOi8vbG9jYWxob3N0OjMwMDEvXCI7XG5cbmV4cG9ydCBjb25zdCB1c2VyTG9naW4gPSAoY3JlZGVudGlhbHMpID0+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBwb3N0Q2FsbChcInVzZXJzL2xvZ2luXCIsIGNyZWRlbnRpYWxzKVxuICAgICAgICAgICAgLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnN0YXR1cyA9PT0gSHR0cFN0YXR1cy5PSykge1xuICAgICAgICAgICAgICAgICAgICBhcGlDb25maWcuYXV0aGVudGljYXRpb25Ub2tlbiA9IHJlc3VsdC5kYXRhLnRva2VuO1xuICAgICAgICAgICAgICAgICAgICBhcGlDb25maWcudXNlcklkID0gcmVzdWx0LmRhdGEuaWQ7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVyci5yZXNwb25zZS5zdGF0dXMgPT09IEh0dHBTdGF0dXMuVU5BVVRIT1JJWkVEKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvci5BVVRIX0ZBSUxFRC5NRVNTQUdFLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29kZTogZXJyb3IuQVVUSF9GQUlMRUQuQ09ERVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoZXJyLnJlc3BvbnNlLnN0YXR1cyA9PT0gSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yLlNFUlZJQ0VfVU5BVkFJTEFCTEUuTUVTU0FHRSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IGVycm9yLlNFUlZJQ0VfVU5BVkFJTEFCTEUuQ09ERVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvci5VTlJFQ09HTklaRURfRVJST1IuTUVTU0FHRSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IGVycm9yLlVOUkVDT0dOSVpFRF9FUlJPUi5DT0RFXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbmV4cG9ydCBjb25zdCBnZXRPcmRlckl0ZW1zID0gKG9yZGVySWQpID0+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBhdXRoZW50aWNhdGVkR2V0Q2FsbChcIm9yZGVycy9cIiArIG9yZGVySWQpXG4gICAgICAgICAgICAudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuc3RhdHVzID09PSBIdHRwU3RhdHVzLk9LKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAocmVzdWx0LnN0YXR1cyA9PT0gSHR0cFN0YXR1cy5OT1RfRk9VTkQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyLnJlc3BvbnNlLnN0YXR1cyA9PT0gSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yLlNFUlZJQ0VfVU5BVkFJTEFCTEUuTUVTU0FHRSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IGVycm9yLlNFUlZJQ0VfVU5BVkFJTEFCTEUuQ09ERVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvci5VTlJFQ09HTklaRURfRVJST1IuTUVTU0FHRSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvZGU6IGVycm9yLlVOUkVDT0dOSVpFRF9FUlJPUi5DT0RFXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgIH0pO1xufVxuXG5cbmV4cG9ydCBjb25zdCB1cGRhdGVPcmRlciA9IChvcmRlcklkLCB1cGRhdGVPcHMpID0+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBwdXRDYWxsKFwib3JkZXJzL1wiICsgb3JkZXJJZCwgdXBkYXRlT3BzKVxuICAgICAgICAgICAgLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7IHJlamVjdCgpIH0pO1xuICAgIH0pO1xufVxuXG5cbi8vIHRoaXMgbmVlZHMgdG8gYmUgY2hhbmdlZFxuZXhwb3J0IGNvbnN0IGdldFVzZXJzT3JkZXJzID0gKCkgPT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGFwaUNvbmZpZy51c2VySWQpO1xuICAgICAgICBhdXRoZW50aWNhdGVkR2V0Q2FsbChcIm9yZGVycy9hbGwvXCIgKyBhcGlDb25maWcudXNlcklkKVxuICAgICAgICAgICAgLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7IHJlamVjdCgpIH0pO1xuICAgIH0pO1xufVxuXG5cbmV4cG9ydCBjb25zdCBnZXRNZW51SXRlbXMgPSAoKSA9PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgYXV0aGVudGljYXRlZEdldENhbGwoXCJpdGVtcy9cIilcbiAgICAgICAgICAgIC50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaChlcnIgPT4geyByZWplY3QoKSB9KTtcbiAgICB9KTtcbn1cblxuXG4vKlxuICAgIFBPU1QsIEdFVCwgUFVUIGNhbGxzIGRlZmluZWRcbiAqL1xuXG5mdW5jdGlvbiBwb3N0Q2FsbCh1cmwsIG15ZGF0YSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGxldCBjYWxsaW5nVXJsID0gYmFzZVVybCArIHVybDtcbiAgICAgICAgYXhpb3MucG9zdChjYWxsaW5nVXJsLCBteWRhdGEpXG4gICAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gSHR0cFN0YXR1cy5PSyB8fCByZXNwb25zZS5zdGF0dXMgPT09IEh0dHBTdGF0dXMuQ1JFQVRFRCkge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyLnJlc3BvbnNlLnN0YXR1cyA9PT0gSHR0cFN0YXR1cy5VTkFVVEhPUklaRUQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJVbmF1dGhvcml6ZWQgcmVxdWVzdCBpbml0aWF0ZWQgZnJvbSBheGlvcyBwb3N0IGNhbGwgaW4gY2FsbEFwaS5qc1wiKTtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKGVyci5yZXNwb25zZS5zdGF0dXMgPT09IEh0dHBTdGF0dXMuSU5URVJOQUxfU0VSVkVSX0VSUk9SKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiSW50ZXJuYWwgU2VydmVyIEVycm9yIGluaXRpYXRlZCBmcm9tIGF4aW9zIHBvc3QgY2FsbCBpbiBjYWxsQXBpLmpzXCIpXG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvci5VTkVYUEVDVEVEX0VSUk9SLk1FU1NBR0UgKyBcIiBpbml0aWF0ZWQgZnJvbSAgYXhpb3MgcG9zdCBjYWxsIGluIGNhbGxBcGkuanNcIik7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgIH0pO1xufVxuXG5cbmZ1bmN0aW9uIGF1dGhlbnRpY2F0ZWRHZXRDYWxsKHVybCwgaGVhZGVyKSB7XG4gICAgY29uc3QgcmVxdWVzdEhlYWRlciA9IHsgaGVhZGVyczogeyBcIkF1dGhvcml6YXRpb25cIjogXCJCZWFyZXIgXCIgKyBhcGlDb25maWcuYXV0aGVudGljYXRpb25Ub2tlbiB9IH07XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBsZXQgY2FsbGluZ1VybCA9IGJhc2VVcmwgKyB1cmw7XG4gICAgICAgIC8vIHJlc29sdmUoYXhpb3MuZ2V0KGNhbGxpbmdVcmwsIHJlcXVlc3RIZWFkZXIpXG4gICAgICAgIC8vICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgIC8vICAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgICAgICAvLyAgICAgfSkpO1xuICAgICAgICBheGlvcy5nZXQoY2FsbGluZ1VybCwgcmVxdWVzdEhlYWRlcilcbiAgICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSBIdHRwU3RhdHVzLk9LIHx8IGVyci5yZXNwb25zZS5zdGF0dXMgPT09IEh0dHBTdGF0dXMuTk9UX0ZPVU5EKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyLnJlc3BvbnNlLnN0YXR1cyA9PT0gSHR0cFN0YXR1cy5JTlRFUk5BTF9TRVJWRVJfRVJST1IpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJJbnRlcm5hbCBTZXJ2ZXIgRXJyb3IgaW5pdGlhdGVkIGZyb20gYXhpb3MgYXV0aGVudGljYXRlZEdldENhbGwgaW4gY2FsbEFwaS5qc1wiKVxuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycm9yLlVORVhQRUNURURfRVJST1IuTUVTU0FHRSArIFwiIGluaXRpYXRlZCBmcm9tICBheGlvcyBhdXRoZW50aWNhdGVkR2V0Q2FsbCBpbiBjYWxsQXBpLmpzXCIpO1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgIH0pO1xufVxuXG5cbmZ1bmN0aW9uIHB1dENhbGwodXJsLCB1cGRhdGVPcHMpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBsZXQgY2FsbGluZ1VybCA9IGJhc2VVcmwgKyB1cmw7XG4gICAgICAgIHJlc29sdmUoYXhpb3MucHV0KGNhbGxpbmdVcmwsIHVwZGF0ZU9wcylcbiAgICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgICAgICAgICB9KSk7XG4gICAgfSk7XG59Il19